#!/usr/bin/make -f
#export DH_VERBOSE = 1

include /usr/share/dpkg/pkg-info.mk

%:
	dh $@

override_dh_auto_build:
	# forget shepherd until it is packaged:
	rm assets/stylesheets/shepherd.scss t/ui/24-feature-tour.t
	# create links to locally installed assets
	# and convince assetpack to use local copies of remote assets:
	mkdir -p node_modules
	ln -s /usr/share/fonts-fork-awesome node_modules/fork-awesome
	ln -s /usr/share/fonts-roboto-fontface node_modules
	# FIXME: should probably locally minify this:
	sed -i -e 's%/fork-awesome\.min\.css%/fork-awesome.css%' assets/assetpack.def
	for ext in eot svg ttf woff woff2 ; do \
		printf '\n! forkawesome-webfont.%s\n< ../node_modules/fork-awesome/fonts/forkawesome-webfont.%s\n' $$ext $$ext >> assets/assetpack.def ; \
	done
	ln -s -s /usr/share/javascript/chosen node_modules/chosen-js
	mkdir -p node_modules/datatables.net-bs4
	ln -s /usr/share/javascript/jquery-datatables node_modules/datatables.net-bs4/js
	ln -s js/css node_modules/datatables.net-bs4/css
	mkdir -p node_modules/datatables
	ln -s ../datatables.net-bs4 node_modules/datatables/media
	ln -s /usr/share/nodejs/bootstrap node_modules/bootstrap
	ln -s /usr/share/nodejs/jquery-ujs node_modules/jquery-ujs
	mkdir -p node_modules/d3
	ln -s /usr/share/javascript/d3 node_modules/d3/dist
	mkdir -p node_modules/jquery/dist
	ln -s /usr/share/javascript/jquery/jquery.min.js node_modules/jquery/dist
	# ln -s /usr/share/nodejs/jquery/dist node_modules/jquery/dist
	ln -s /usr/share/nodejs/codemirror node_modules/codemirror
	ln -s /usr/share/javascript/jquery-timeago node_modules/timeago
	cp -v -r debian/missing-sources/bootstrap-4-multi-dropdown-navbar_957865f9 node_modules/bootstrap-4-multi-dropdown-navbar_957865f9
	ln -s /usr/share/nodejs/popper.js/dist node_modules/libjs-popper.js
	ln -s /usr/share/nodejs/jquery-ujs/src node_modules/node-jquery-ujs
	cp -v -r debian/missing-sources/d3js_4.13.0 node_modules/d3js_4.13.0
	tar -xvz --transform='s%.*dist%node_modules/dagre-d3/dist%' -f debian/missing-sources/dagre-d3_0.5.0/v0.5.0.tar.gz dagre-d3-0.5.0/dist/dagre-d3.js
	mkdir -p node_modules/anser/lib
	cp debian/missing-sources/anser_2.0.1/index.js node_modules/anser/lib
	ln -sf /usr/share/javascript/cropper/cropper.css assets/stylesheets/cropper.css
	# ensure that there are no remote references left
	! grep http assets/assetpack.def

override_dh_auto_install:
	dh_auto_install -- SHELL="/bin/bash" GENERATE_PACKED_ASSETS_FAILS_ON_MISSING_ASSETS=1

execute_after_dh_install:
	# make #! lines Debian Perl/Python Policy compliant
	find $(CURDIR)/debian/openqa*/usr/share/openqa -type f -print0 | \
		xargs -r0 sed -i -e '1s%^\(#!/usr/bin/\)env \(perl\|python3\)%\1\2%'
	# apache & nginx vhost configs are found in .../sites-available on Debian
	sed -i 's#\bvhosts\.d\b#sites-available#' \
		$(CURDIR)/debian/openqa/usr/share/openqa/script/configure-web-proxy \
		$(CURDIR)/debian/openqa/etc/*/sites-available/openqa*.conf.template

execute_after_dh_fixperms:
	chmod -x debian/openqa/etc/logrotate.d/openqa
	chmod +x debian/openqa/usr/share/openqa/dbicdh/*/upgrade/*-*/0*-*.pl

override_dh_auto_test:
	# remeber, there used to be more disabled tests here, inspired by the RPM spec file.
	# revert the change that introduced this comment if those tests start failing again.

	# FIXME: upstream depends upon a version of perltidy that's not yet in Debian
	rm -f ./t/00-tidy.t
	# On debian we can't run test connecting to internet
	rm -f ./t/40-script_openqa-clone-custom-git-refspec.t \
		./t/40-openqa-clone-job.t
	# Not enough permission for unshare use
	rm -f ./t/32-openqa_client-script.t

	-export CI=1; export OPENQA_TEST_TIMEOUT_SCALE_CI=10 ; \
		PATH=$$PATH:$$(ls -d /usr/lib/postgresql/*/bin) FULLSTACK=1 \
		dh_auto_test -- \
		SHELL="bash -x" PROVE_ARGS='-r -v' CHECKSTYLE=0 TEST_PG_PATH=$(CURDIR)/debian/DB

execute_before_dh_auto_clean:
	rm -fr node_modules/
	rm -fr t/data/openqa/testresults/ .sass-cache/ assets/cache
	rm -f assets/assetpack.db job.json t/data/openqa/pool/1/.locked t/data/openqa/pool/1/t/data/openqa/pool/1/.locked t/data/openqa/pool/1/t/data/openqa/pool/1/t/data/openqa/pool/1/.locked t/data/openqa/pool/1/t/data/openqa/pool/1/t/data/openqa/pool/1/worker-log.txt t/data/openqa/pool/1/t/data/openqa/pool/1/worker-log.txt t/data/openqa/share/factory/iso/Core-7.2.iso t/data/openqa/share/tests/opensuse/needles/inst-timezone-text.json t/data/openqa/webui/cache/asset-status.json
	rm -f t/data/openqa/share/factory/hdd/00099963-hdd_image3.qcow2 t/data/openqa/share/factory/hdd/00099963-hdd_image7.qcow2 t/data/openqa/share/factory/hdd/hdd_image2.qcow2 t/data/openqa/share/factory/hdd/hdd_image5.qcow2 t/data/openqa/share/factory/other/00099963-hdd_image3.xml t/data/openqa/share/factory/other/00099963-hdd_image4.xml
	rm -fr $(CURDIR)/debian/DB

pod2man_opts := --errors=stderr --section=1 --center "openQA Documentation" --release 'openQA $(DEB_VERSION_UPSTREAM)'
execute_before_dh_installman:
	make build-manpages -- DESTDIR=debian/tmp OPENQA_VERSION=$(DEB_VERSION_UPSTREAM)
